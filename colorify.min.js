/**
*
* Copyright (c) 2015 Marco Liberati
* Distributed under the GNU GPL v2. For full terms see the file LICENSE.
*
*/!function(t){function n(t){return t&&"[object Function]"==={}.toString.call(t)}function r(t){return"string"==typeof t}function a(t){return null!=t}function e(t,n){return n?Array.isArray(t)?t:r(t)?[t]:[]:Array.isArray(t)?t:[t]}function o(t,n){var r=document.createElement("canvas");return r.width=t||1,r.height=n||1,r}function i(){var t=document.createElement("canvas");t.width=t.height=1;var n=t.getContext("2d");return n.globalCompositeOperation="screen","screen"===n.globalCompositeOperation}function c(t,e,o,i){var c={},u=Object.keys(e);u.forEach(function(n){c[n]=a(t[n])?!!t[n]:e[n]});var f=Object.keys(o);f.forEach(function(n){c[n]=r(t[n])?t[n]:o[n]});var g=Object.keys(i);g.forEach(function(r){c[r]=n(t[r])?t[r]:i[r]});var h=Object.keys(t);return h.forEach(function(n){n in c||(c[n]=t[n])}),c}function u(t){var n=null;if(t.length){var r=t.map(function(t){return t.message});n=new Error("Error loading the following images: "+r.join(","))}return n}function f(t,i,f){function h(t,n,r){return Math.floor((t+n+r)/3)}function s(t,n,r){return Math.floor(.2125*t+.7154*n+.0721*r)}if(n(f)){t=e(t,!0),i=c(i,{},{},{canvasMaker:o});var l={average:h,maxLuminosity:Math.max,minLuminosity:Math.min,greyscale:s,grayscale:s};i.strategy=a(i.strategy)?i.strategy:"average",i.strategy=r(i.strategy)&&i.strategy in l?l[i.strategy]:i.strategy,i.strategy=n(i.strategy)?i.strategy:l.average,g(t,i,function(n,r){var a=t.map(function(t){return r[t]});return f(u(n),a)})}}function g(t,n,r){function a(){i++,i===t.length&&e()}function e(){var t=Object.keys(o);t.forEach(function(t){c[t]=h(o[t],n)}),r(u,c)}var o={},i=0,c={},u=[];t.forEach(function(t){if(o[t])a();else{var n=new Image;n.onload=a,n.onerror=a,n.src=t,o[t]=n}})}function h(t,n){var r=n.canvasMaker(t.width,t.height),a=r.getContext("2d");a.drawImage(t,0,0);var e,o=a.getImageData(0,0,r.width,r.height),i=0,c=o.data,u=n.strategy;for(e=0;e<c.length;e+=4)c[e+3]&&(c[e]=c[e+1]=c[e+2]=u(c[e],c[e+1],c[e+2]),i=Math.max(i,c[e]));var f=255-i;for(e=0;e<c.length;e+=4)if(c[e+3]){var g=c[e];c[e]=c[e+1]=c[e+2]=g+f}return a.putImageData(o,0,0),r}function s(t,n,r){return r=c(r,{},{},{canvasFn:o}),n=v(n)?[n]:e(n),l(t,r.canvasFn,n)}function l(t,n,r){var a=t.width,e=t.height,o=[];return r.forEach(function(){o.push(n(a,e))}),i()?d(t,o,r):m(t,o,r),o.map(function(t){return t.toDataURL()})}function v(t){return Array.isArray(t)&&"value"in t[0]}function y(t,n,r){var a;v(r)?(a=n.createLinearGradient(t.width/2,0,t.width/2,t.height),r.forEach(function(t){a.addColorStop(t.value,t.color)})):a=r,n.fillStyle=a,n.fillRect(0,0,t.width,t.height)}function d(t,n,r){var a=t.width,e=t.height;n.forEach(function(n,o){var i=n.getContext("2d");y(t,i,r[o]),i.globalCompositeOperation="multiply",i.drawImage(t,0,0,a,e),i.globalCompositeOperation="destination-atop",i.drawImage(t,0,0,a,e)})}function m(t,n,r){function a(t,n){return function(r){r[h]=Math.floor(t*r[h]),r[h+1]=Math.floor(t*r[h+1]),r[h+2]=Math.floor(t*r[h+2]),r[h+3]=n}}var e=t.width,o=t.height;context=t.getContext("2d");var i=context.getImageData(0,0,e,o),c=i.data,u=[],f=[],g=[];n.forEach(function(n){var r=n.getContext("2d");y(t,r,color);var a=tContext.getImageData(0,0,e,o);u.push(r),f.push(a),g.push(a.data)});for(var h=0;h<c.length;h+=4)c[h+3]>0&&g.forEach(a(c[h]/255,c[h+3]));u.forEach(function(t,n){t.putImageData(imagesDatas[n],0,0)})}function p(t,n,r,a){a&&(t=e(t,!0),n=v(n)?[n]:e(n),f(t,r,function(e,o){if(e)return a(e);var i={};o.forEach(function(a,e){return i[t[e]]?void 0:(i[t[e]]=s(a,n,r),i[t[e]])});var c=t.map(function(t){return i[t]});return a(null,c)}))}t.Colorify={},Colorify.create=function(){return{recolor:p,getMask:f,paint:s}}}("undefined"==typeof exports?this.Colorify={}:exports);